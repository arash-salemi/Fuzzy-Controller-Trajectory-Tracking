function [cost,res] = flc_cost(p)

FLC = readfis('FLC.fis');

% s = floor(p(1:5));

% ix1 = {1;
%       [2 6];
%       [3 7 11];
%       [4 8 12 16]};
%   
% ix2 = {25;
%       [20 24];
%       [15 19 23];
%       [10 14 18 22]};
% 
% for i = 1:numel(ix1)
%     for j = 1:numel(ix1{i})
%         flc.rule(ix1{i}(j)).consequent = s(i);
%         flc.rule(ix2{i}(j)).consequent = 8 - s(i);
%     end
% end
% 
% for i = [5 9 13 17 21]
%     flc.rule(i).consequent = s(5);
% end


FLC.inputs(1).mf(1).params = [0 0 p(1)];
FLC.inputs(1).mf(2).params = [0 p(1) p(2)];
FLC.inputs(1).mf(3).params = [p(1) p(2) p(3)];
FLC.inputs(1).mf(4).params = [p(2) p(3) p(4)];
FLC.inputs(1).mf(5).params = [p(3) p(4) 20 20];

FLC.inputs(2).mf(1).params = [-5.5 -5.5 p(5) p(6)];
FLC.inputs(2).mf(2).params = [p(5) p(6) 0];
FLC.inputs(2).mf(3).params = [p(6) 0 -p(6)];
FLC.inputs(2).mf(4).params = [0 -p(6) -p(5)];
FLC.inputs(2).mf(5).params = [-p(6) -p(5) 5.5 5.5];

% p(8:9) = sort(p(8:9));

FLC.output(1).mf(1).params = [p(10) p(11) 3];
FLC.output(1).mf(2).params = [p(9) p(10) p(11)];
FLC.output(1).mf(3).params = [p(8) p(9) p(10)];
FLC.output(1).mf(4).params = [p(7) p(8) p(9)];
FLC.output(1).mf(5).params = [0 p(7) p(8)];

FLC.output(2).mf(1).params = [-3 p(12) p(13)];
FLC.output(2).mf(2).params = [p(12) p(13) 0];
FLC.output(2).mf(3).params = [p(13) 0 -p(13)];
FLC.output(2).mf(4).params = [0 -p(13) -p(12)];
FLC.output(2).mf(5).params = [-p(13) -p(12) 3];


% ki1 = p(10);
% ki2 = p(11);
% ko = p(12);

%% Trajectory

% x_ref = squeeze(out.X);
% y_ref = squeeze(out.Y);

x_ref = [0;4.94939929771948e-11;1.97975703863767e-10;1.44229192552729e-09;3.82969671769078e-09;4.89664111858171e-09;6.09452701586191e-09;1.40480575372136e-08;1.99239214220086e-08;2.68237713765140e-08;3.45646963772227e-08;3.99534438402062e-08;4.20249887660270e-08;4.41488866087360e-08;5.55536641620709e-08;7.32356090835273e-08;9.33565776744633e-08;9.65338936018009e-08;9.97643740156670e-08;1.16714237842516e-07;1.67443045864700e-07;2.03503552269928e-07;2.27344838242625e-07;2.52506281591587e-07;2.79565923386975e-07;3.56725975781764e-07;4.09161246962031e-07;4.43000903221849e-07;4.78184695247343e-07;5.15435621015026e-07;6.22339989952458e-07;6.95086526538012e-07;7.42690028857349e-07;7.91869802839125e-07;8.44672100356708e-07;9.98891576218537e-07;1.10530378690290e-06;1.21709971858326e-06;1.32225896584051e-06;1.38709113392855e-06;1.43945094972648e-06;1.48066321294446e-06;1.52245700535488e-06;1.55940765525613e-06;1.75080486139237e-06;1.86267061227267e-06;1.97799938808763e-06;2.10367701445701e-06;2.26745861207053e-06;2.31855608879968e-06;2.37022274358440e-06;2.43784848384626e-06;2.49369025970007e-06;2.56626706199618e-06;2.68808281714076e-06;2.77423878172669e-06;2.84397974430708e-06;2.91458617513467e-06;3.28059998864308e-06;3.49407628661082e-06;3.63955321194048e-06;3.78799606097198e-06;4.26555747077601e-06;4.41824210096632e-06;4.57361044028053e-06;4.76000563653044e-06;5.34135711770651e-06;5.52203924631748e-06;5.70572533994760e-06;5.92914731816752e-06;6.19209393217999e-06;6.90620073907179e-06;7.16505535328035e-06;7.35607463574895e-06;7.50984079097283e-06;7.66519662605849e-06;8.14366668837742e-06;8.63661320892596e-06;9.28691157733344e-06;9.96079737529431e-06;1.06277263139234e-05;1.16071793056642e-05;1.22691047304227e-05;1.29493715955141e-05;1.37002277529170e-05;1.77716456787206e-05;2.21811164166835e-05;2.33933788580030e-05;2.46378617904843e-05;3.13435008327262e-05;3.86280130096293e-05;4.29959065681751e-05;4.75973926342612e-05;5.21550037187192e-05;7.80628633350161e-05;9.12303591385366e-05;9.89679102270606e-05;0.000107019736636188;0.000130550976351894;0.000137531169738138;0.000144692717431991;0.000152695907541149;0.000177248422518557;0.000192537549724736;0.000208457319738588;0.000228288044448304;0.000240302192368657;0.000248651297968810;0.000257142535102668;0.000261429542643993;0.000265751879106271;0.000287893399002649;0.000319342221497913;0.000352414933314354;0.000385459163453048;0.000425765682879145;0.000474469047629497;0.000525797462061031;0.000576766308646332;0.000627711627101305;0.000914584152379387;0.00106006656739969;0.00121620872026104;0.00125805523013623;0.00130060452277586;0.00136979317622715;0.00144076141728086;0.00146736281451440;0.00149420569947833;0.00163204068653949;0.00180094533547320;0.00185625970426626;0.00191240353306814;0.00196106251521049;0.00221344168141354;0.00250876414445708;0.00259671365974920;0.00268616282101073;0.00315587586783180;0.00341517621617148;0.00349977866360576;0.00358540392412812;0.00364802410856470;0.00371117984476894;0.00403498589409931;0.00423202928859383;0.00443370754041026;0.00460102446243989;0.00467019735870316;0.00473987926958521;0.00509591852897610;0.00554371413179021;0.00601007202786392;0.00645519025001075;0.00673268934351081;0.00701592984235490;0.00712871849803724;0.00724239112244443;0.00743000652101810;0.00761997882976209;0.00860513817255016;0.00974888840166896;0.0100872677071615;0.0104312999616924;0.0122360452293185;0.0142224007438174;0.0145053100447300;0.0147909358663201;0.0162597414099050;0.0203659094804084;0.0227477190897023;0.0252568432573878;0.0276708649227087;0.0343957583597073;0.0418196833015556;0.0454886736341889;0.0493045016838435;0.0705551023146411;0.0809144793901295;0.0919346974862241;0.102043498977078;0.129367737980891;0.144761301558925;0.160936853006486;0.176122155216985;0.196393512308730;0.208397876926398;0.220716097186730;0.228788052924039;0.236986869899325;0.248223833111184;0.264779954139176;0.281796022044029;0.287291790932788;0.292832953113575;0.321211732464716;0.335149763647013;0.349335608369690;0.365045296374905;0.382181581332759;0.472604167749384;0.508938519281005;0.546315276057942;0.747667534423978;1.16189779529999;1.62025266619737;2.09815614711611;2.57103223805620;3.01430493901766;3.40339825000047;3.71373617100465;3.92074270203019;3.99984184307708;4.09962557661608;4.39422368035001;4.84716869911597;5.42159663291398;6.08064348174402;6.78744524560611;7.50513792450023;8.17936718606116;8.81036725605415;9.34263252017114;9.73929897841214;9.96350263077715;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10];
y_ref = [0;-2.47469964885974e-11;-9.89878519318836e-11;-7.21145962763643e-10;-1.91484835884539e-09;-2.44832055929086e-09;-3.04726350793096e-09;-7.02402876860678e-09;-9.96196071100430e-09;-1.34118856882570e-08;-1.72823481886114e-08;-1.99767219201031e-08;-2.10124943830135e-08;-2.20744433043680e-08;-2.77768320810354e-08;-3.66178045417637e-08;-4.66782888372317e-08;-4.82669468009004e-08;-4.98821870078335e-08;-5.83571189212581e-08;-8.37215229323502e-08;-1.01751776134964e-07;-1.13672419121312e-07;-1.26253140795793e-07;-1.39782961693488e-07;-1.78362987890882e-07;-2.04580623481015e-07;-2.21500451610924e-07;-2.39092347623671e-07;-2.57717810507513e-07;-3.11169994976229e-07;-3.47543263269006e-07;-3.71345014428674e-07;-3.95934901419563e-07;-4.22336050178354e-07;-4.99445788109269e-07;-5.52651893451449e-07;-6.08549859291632e-07;-6.61129482920256e-07;-6.93545566964273e-07;-7.19725474863239e-07;-7.40331606472228e-07;-7.61228502677439e-07;-7.79703827628066e-07;-8.75402430696183e-07;-9.31335306136334e-07;-9.88999694043814e-07;-1.05183850722851e-06;-1.13372930603527e-06;-1.15927804439984e-06;-1.18511137179220e-06;-1.21892424192313e-06;-1.24684512985004e-06;-1.28313353099809e-06;-1.34404140857038e-06;-1.38711939086335e-06;-1.42198987215354e-06;-1.45729308756734e-06;-1.64029999432154e-06;-1.74703814330541e-06;-1.81977660597024e-06;-1.89399803048599e-06;-2.13277873538800e-06;-2.20912105048316e-06;-2.28680522014027e-06;-2.38000281826522e-06;-2.67067855885326e-06;-2.76101962315874e-06;-2.85286266997380e-06;-2.96457365908376e-06;-3.09604696609000e-06;-3.45310036953590e-06;-3.58252767664018e-06;-3.67803731787447e-06;-3.75492039548642e-06;-3.83259831302925e-06;-4.07183334418871e-06;-4.31830660446298e-06;-4.64345578866672e-06;-4.98039868764716e-06;-5.31386315696168e-06;-5.80358965283209e-06;-6.13455236521133e-06;-6.47468579775704e-06;-6.85011387645848e-06;-8.88582283936029e-06;-1.10905582083418e-05;-1.16966894290015e-05;-1.23189308952422e-05;-1.56717504163631e-05;-1.93140065048146e-05;-2.14979532840875e-05;-2.37986963171306e-05;-2.60775018593596e-05;-3.90314316675080e-05;-4.56151795692683e-05;-4.94839551135303e-05;-5.35098683180942e-05;-6.52754881759472e-05;-6.87655848690692e-05;-7.23463587159955e-05;-7.63479537705747e-05;-8.86242112592784e-05;-9.62687748623679e-05;-0.000104228659869294;-0.000114144022224152;-0.000120151096184329;-0.000124325648984405;-0.000128571267551334;-0.000130714771321997;-0.000132875939553136;-0.000143946699501324;-0.000159671110748956;-0.000176207466657177;-0.000192729581726524;-0.000212882841439572;-0.000237234523814749;-0.000262898731030516;-0.000288383154323166;-0.000313855813550652;-0.000457292076189693;-0.000530033283699843;-0.000608104360130518;-0.000629027615068113;-0.000650302261387931;-0.000684896588113574;-0.000720380708640431;-0.000733681407257198;-0.000747102849739164;-0.000816020343269744;-0.000900472667736601;-0.000928129852133129;-0.000956201766534070;-0.000980531257605246;-0.00110672084070677;-0.00125438207222854;-0.00129835682987460;-0.00134308141050537;-0.00157793793391590;-0.00170758810808574;-0.00174988933180288;-0.00179270196206406;-0.00182401205428235;-0.00185558992238447;-0.00201749294704965;-0.00211601464429691;-0.00221685377020513;-0.00230051223121995;-0.00233509867935158;-0.00236993963479260;-0.00254795926448805;-0.00277185706589510;-0.00300503601393196;-0.00322759512500538;-0.00336634467175540;-0.00350796492117745;-0.00356435924901862;-0.00362119556122221;-0.00371500326050905;-0.00380998941488105;-0.00430256908627508;-0.00487444420083448;-0.00504363385358077;-0.00521564998084620;-0.00611802261465924;-0.00711120037190871;-0.00725265502236501;-0.00739546793316006;-0.00812987070495252;-0.0101829547402042;-0.0113738595448512;-0.0126284216286939;-0.0138354324613544;-0.0171978791798537;-0.0209098416507778;-0.0227443368170945;-0.0246522508419218;-0.0352775511573205;-0.0404572396950647;-0.0459673487431120;-0.0510217494885391;-0.0646838689904457;-0.0723806507794623;-0.0804684265032431;-0.0880610776084924;-0.0981967561543650;-0.104198938463199;-0.110358048593365;-0.114394026462019;-0.118493434949663;-0.124111916555592;-0.132389977069588;-0.140898011022014;-0.143645895466394;-0.146416476556788;-0.160605866232358;-0.167574881823506;-0.174667804184845;-0.182522648187453;-0.191090790666379;-0.236302083874692;-0.254469259640502;-0.273157638028971;-0.373833767211989;-0.580948897649997;-0.810126333098685;-1.04907807355805;-1.28551611902810;-1.50715246950883;-1.70169912500024;-1.85686808550233;-1.96037135101509;-1.99992092153854;-1.80074884676784;-1.21155263929999;-0.305662601768057;0.843193265827955;2.16128696348805;3.57489049121222;5.01027584900047;6.35873437212232;7.62073451210829;8.68526504034228;9.47859795682428;9.92700526155430;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10;10];
%%

% t = out.tout;
t = [0;1.01544386834494e-05;2.03088773668987e-05;5.48160269110978e-05;8.93231764552968e-05;0.000101002341788368;0.000112681507121438;0.000171077333786792;0.000203738305759382;0.000236399277731972;0.000268351189177352;0.000288512639968892;0.000295897810503139;0.000303282981037387;0.000340208833708627;0.000390617629436764;0.000441026425164901;0.000448468844776348;0.000455911264387795;0.000493123362445029;0.000590649772136931;0.000651154778886634;0.000688243087242354;0.000725331395598074;0.000763209199222736;0.000862127922504662;0.000923322380570847;0.000960748036245643;0.000998173691920440;0.00103632649711252;0.00113874427896655;0.00120346555090506;0.00124399661414121;0.00128452767737735;0.00132666682887234;0.00144271428353071;0.00151762388993653;0.00159253349634234;0.00165991445281950;0.00170012599768819;0.00173192055513391;0.00175654138963288;0.00178116222413185;0.00180264999040204;0.00191008882175299;0.00197017345122636;0.00203025808069973;0.00209377274183326;0.00217376209568545;0.00219812221817831;0.00222248234067117;0.00225396934542731;0.00227964199170189;0.00231258270124088;0.00236684185994294;0.00240447866838476;0.00243451877817218;0.00246455888795960;0.00261475943689672;0.00269850804129947;0.00275412198881205;0.00280973593632463;0.00298162914078579;0.00303453403388603;0.00308743892698626;0.00314973726153729;0.00333658209147660;0.00339255871429048;0.00344853533710436;0.00351542071561318;0.00359254476995203;0.00379410074350052;0.00386456908896961;0.00391575803017668;0.00395648322285938;0.00399720841554209;0.00412010893191277;0.00424300944828346;0.00439989653494604;0.00455678362160862;0.00470690988862017;0.00491909485468165;0.00505745812945340;0.00519582140422515;0.00534438905422078;0.00608722730419893;0.00680092645204184;0.00698438500627221;0.00716784356050258;0.00808513633165443;0.00897616046796813;0.00947037781649399;0.00996459516501985;0.0104310876044884;0.0127635498018312;0.0137990428980470;0.0143728574206074;0.0149466719431678;0.0165100346508208;0.0169461539011230;0.0173822731514251;0.0178570910199992;0.0192410324237149;0.0200548087845794;0.0208685851454438;0.0218400798971019;0.0224082532647015;0.0227947969806018;0.0231813406965020;0.0233740795926466;0.0235668184887911;0.0245305129695139;0.0258378829972647;0.0271452530250155;0.0283917494472261;0.0298421735164125;0.0315063030957422;0.0331704326750718;0.0347446243287782;0.0362502967508589;0.0437786588612625;0.0471427791435403;0.0505068994258181;0.0513714362236469;0.0522359730214756;0.0536123310930271;0.0549886891645786;0.0554958976815284;0.0560031061984781;0.0585391487832268;0.0615060406686019;0.0624473993144221;0.0633887579602424;0.0641935945855753;0.0682177777122399;0.0726478762852777;0.0739166258296551;0.0751853753740325;0.0815291230959195;0.0848312864974489;0.0858816829600849;0.0869320794227208;0.0876924385740732;0.0884527977254256;0.0922545934821876;0.0944946006319398;0.0967346077816920;0.0985550831007196;0.0992981542546768;0.100041225408634;0.103756581178420;0.108252231397749;0.112747881617079;0.116881185398119;0.119387289563875;0.121893393729631;0.122877466133690;0.123861538537748;0.125469282943224;0.127077027348699;0.135115749376077;0.143900989224174;0.146401943631631;0.148902898039089;0.161407670076378;0.174167848418069;0.175912523909033;0.177657199399998;0.186380576854820;0.208913152149244;0.220974583170330;0.233036014191416;0.244104548537350;0.272693138456631;0.301281728375913;0.314509257121337;0.327736785866760;0.393874429593880;0.422656946832391;0.451439464070901;0.476457964327862;0.538868873020614;0.571363322616529;0.603857772212444;0.633045496650186;0.670305759493366;0.691565007944819;0.712824256396272;0.726472598789293;0.740120941182314;0.758496108795268;0.784923020648207;0.811349932501147;0.819737609046926;0.828125285592706;0.870063668321604;0.890085114591641;0.910106560861677;0.931886607867738;0.955205660774356;1.07180092530744;1.11609022294451;1.16037952058158;1.38182600876693;1.78182600876693;2.18182600876693;2.58182600876693;2.98182600876693;3.38182600876693;3.78182600876693;4.18182600876693;4.58182600876693;4.98182600876693;5.38182600876693;5.78182600876693;6.18182600876693;6.58182600876693;6.98182600876693;7.38182600876693;7.78182600876693;8.17134120959193;8.57134120959193;8.97134120959193;9.37134120959193;9.77134120959193;10.1713412095919;10.5713412095919;10.9713412095919;11.3713412095919;11.7713412095919;12.1713412095919;12.5713412095919;12.9713412095919;13.3713412095919;13.7713412095919;14.1713412095919;14.5713412095919;14.9713412095919;15.3713412095919;15.7713412095919;16.1713412095919;16.5713412095919;16.9713412095919;17.3713412095919;17.7713412095919;18.1713412095919;18.5713412095919;18.7578725249731;18.8582482431814;18.9586239613896;19.0570455584036;19.4570455584036;19.8570455584036;20];

x = [0 0 0];

x1 = x(1);
y1 = x(2);
theta = x(3); % heading angle


d_x = x1 - x_ref(1);
d_y = y1 - y_ref(1);
d = sqrt(d_x^2+d_y^2);

u = zeros(1,2);

X = x1;
Y = y1;
Theta = theta;
V = u(1);
Sai = u(2); % steclcering angle

D = d;
E_sai = 0;

for i=1:length(t)-1
    
    [T,s] = ode45(@(t,x)Mobilerobots(t,x,u),[t(i) t(i+1)],x);
    
    x = s(end,:);
    
    x1 = x(1);
    y1 = x(2);
    theta = x(3);

    % Preparing the inputs of controller
    
    d_x = x1-x_ref(i);
    d_y = y1-y_ref(i);
    d = sqrt(d_x^2+d_y^2); % input controller 1
    
    si = atan2(d_y,d_x);
    e_sai = si - theta;      % input controller 2

    u = evalfis(FLC,[d e_sai]);  % outputs of controller which are inputs of our plant
    
    X = [X; x1];
    Y = [Y; y1];
    Theta = [Theta theta];
    V = [V; u(1)];        % input plant 1
    Sai = [Sai; u(2)];    % input plant 2
    
    D = [D d];
    E_sai = [E_sai e_sai];

end

a = sum(D.^2);
b = sum(E_sai.^2);

cost = a+b;

res.Y = Y;
res.X = X;
res.Theta = Theta;
res.V = V;
res.Sai = Sai;
res.FLC = FLC;
end
